name: 构建 Docker镜像  # Actions名称，用于在GitHub界面显示

on:  # 定义触发工作流的事件
  release:  # 当发布新的GitHub release时触发
    types: [published]  # 仅在release发布时触发（非草稿、非预发布）
  workflow_dispatch:  # 允许手动触发工作流
    inputs:  # 手动触发时可输入的参数
      tag:  # 参数名称
        description: '构建的版本号'  # 参数描述
        required: true  # 必须提供参数
        default: 'test'  # 默认值

permissions:  # 工作流权限设置
  contents: read  # 需要读取仓库内容的权限
  packages: write  # 需要写入GitHub Packages的权限

jobs:  # 定义工作流中的作业
  build-images:  # 作业ID，唯一标识
    name: 构建镜像 ${{ matrix.image-type }}  # 作业显示名称，使用矩阵变量
    runs-on: ubuntu-latest  # 运行环境：最新版Ubuntu
    strategy:  # 策略配置
      matrix:  # 矩阵策略，用于并行执行多个任务
        image-type: [openvpn, admin]  # 定义两种镜像类型
        include:  # 为每种类型指定特定参数
          - image-type: openvpn
            dockerfile: Dockerfile.openvpn
            version_prefix: ''
            latest_prefix: ''
          - image-type: admin
            dockerfile: Dockerfile.ovpn-admin
            version_prefix: 'admin-'
            latest_prefix: 'admin-'
    
    steps:  # 定义作业中的步骤
      # 步骤1：检出代码
      - name: 检出代码  # 步骤名称
        uses: actions/checkout@v4  # 使用官方检出动作
        # with:  # 可选参数
        #   fetch-depth: '0'  # 获取所有历史记录（默认只获取最新提交）

      # 步骤2：设置QEMU模拟器
      - name: 设置 QEMU  # 步骤名称
        uses: docker/setup-qemu-action@v3  # 使用官方QEMU设置动作
        # 作用：支持构建多平台镜像（如ARM架构）

      # 步骤3：设置Docker Buildx
      - name: 设置 Docker Buildx  # 步骤名称
        uses: docker/setup-buildx-action@v3  # 使用官方Buildx设置动作
        # 作用：增强Docker构建功能，支持多平台构建和缓存优化

      # 步骤4：获取镜像标签名称
      - name: 获取 Image Tag  # 步骤名称
        run: |  # 执行Shell命令
          # 判断是否为手动触发且提供了tag参数
          if [ x"${{ github.event.inputs.tag }}" == x"" ]; then
            # 如果是release触发，从Git引用中提取版本号
            echo "TAG_NAME=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
          else
            # 如果是手动触发，使用输入的tag参数
            echo "TAG_NAME=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          fi
        # 作用：根据触发方式确定版本号，存储到环境变量TAG_NAME中

      # 步骤5：登录Docker Hub
      - name: 登录 DockerHub  # 步骤名称
        uses: docker/login-action@v3  # 使用官方登录动作
        with:  # 动作参数
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Docker Hub用户名(需在secrets中配置)
          password: ${{ secrets.DOCKERHUB_PASSWORD }}  # Docker Hub密码(需在secrets中配置)
        # 作用：认证Docker Hub，允许推送镜像

      # 步骤6：登录GitHub Container Registry
      - name: 登录 GitHub Container Registry  # 步骤名称
        uses: docker/login-action@v3  # 使用官方登录动作
        with:  # 动作参数
          registry: ghcr.io  # GitHub Container Registry地址
          username: ${{ github.actor }}  # GitHub用户名
          password: ${{ secrets.GITHUB_TOKEN }}  # GitHub Token(无需配置,由GitHub提供)
        # 作用：认证GitHub Container Registry，允许推送镜像

      # 步骤7：设置镜像标签
      - name: 设置 Image Tags  # 步骤名称
        run: |  # 执行Shell命令
          # 设置Docker Hub版本标签
          echo "DHUB_TAG_VERSION=${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${{ matrix.version_prefix }}${{ env.TAG_NAME }}" >> $GITHUB_ENV
          # 设置Docker Hub最新标签
          echo "DHUB_TAG_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${{ matrix.latest_prefix }}latest" >> $GITHUB_ENV
          
          # 设置GitHub Container Registry版本标签
          echo "GHCR_TAG_VERSION=ghcr.io/${{ github.repository }}:${{ matrix.version_prefix }}${{ env.TAG_NAME }}" >> $GITHUB_ENV
          # 设置GitHub Container Registry最新标签
          echo "GHCR_TAG_LATEST=ghcr.io/${{ github.repository }}:${{ matrix.latest_prefix }}latest" >> $GITHUB_ENV
        # 作用：为两个注册表生成镜像标签，存储到环境变量中

      # 步骤8：打印构建信息（调试用）
      - name: 打印构建信息  # 步骤名称
        run: |  # 执行Shell命令
          echo "======================================"  # 分隔线
          echo "构建类型: ${{ matrix.image-type }}"  # 打印镜像类型
          echo "使用Dockerfile: ${{ matrix.dockerfile }}"  # 打印Dockerfile路径
          echo "Docker Hub版本标签: ${{ env.DHUB_TAG_VERSION }}"  # 打印Docker Hub版本标签
          echo "Docker Hub最新标签: ${{ env.DHUB_TAG_LATEST }}"  # 打印Docker Hub最新标签
          echo "GitHub CR版本标签: ${{ env.GHCR_TAG_VERSION }}"  # 打印GitHub CR版本标签
          echo "GitHub CR最新标签: ${{ env.GHCR_TAG_LATEST }}"  # 打印GitHub CR最新标签
          echo "======================================"  # 分隔线
        # 作用：在日志中显示构建详情，便于调试和验证

      # 步骤9：构建并推送镜像
      - name: 编译并推送镜像  # 步骤名称
        uses: docker/build-push-action@v5  # 使用官方构建推送动作
        with:  # 动作参数
          context: .  # 构建上下文路径（当前目录）
          file: ./${{ matrix.dockerfile }}  # 指定Dockerfile路径（使用矩阵变量）
          platforms: linux/amd64,linux/arm64,linux/arm/v7  # 多平台构建
          push: true  # 推送到镜像仓库
          tags: |  # 要应用的标签列表（包含两个注册表的标签）
            ${{ env.DHUB_TAG_VERSION }}
            ${{ env.DHUB_TAG_LATEST }}
            ${{ env.GHCR_TAG_VERSION }}
            ${{ env.GHCR_TAG_LATEST }}
        # 作用：使用指定的Dockerfile构建镜像，并推送到Docker Hub和GitHub Container Registry
